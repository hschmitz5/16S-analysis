---
title: "ANCOM-BC2 Differential Abundance"
output: html_document
date: "2025-10-23"
---
# Generate Diff Abundance Data
```{r diff_ab_ancom2}
fname <- paste0("../results/ancombc2_output.rds")
  
if (file.exists(fname)) {
  print("loading ANCOM2 data")
  output <- readRDS(fname)
} else {
  contrast_mats = list(
    matrix(c(1, 0, 0, 0, 0, -1, 1, 0, 0, 0, 0, -1, 1, 0, 0, 0, 0, -1, 1, 0, 0, 0, 0, -1, 1),
    nrow = 5, byrow = TRUE),
    matrix(c(-1, 0, 0, 0, 0, 1, -1, 0, 0, 0, 0, 1, -1, 0, 0, 0, 0, 1, -1, 0, 0, 0, 0, 1, -1),
    nrow = 5, byrow = TRUE)
  )
  
  set.seed(123)
  output <- ancombc2(
    data = ps_filt, 
    fix_formula = "size.name",    
    group = "size.name",
    struc_zero = TRUE,
    global = TRUE, pairwise = TRUE, dunnet = TRUE, trend = TRUE,  
    trend_control = list(contrast = contrast_mats,
                    node = list(5, 5),
                    solver = "ECOS",
                    B = 100)
  )
  
  saveRDS(output, file = fname)
}
```
# Process Data
```{r ancom2_process}
# renames column
taxonomy <- taxonomy %>%
  rename(taxon = seq,) 

# define significant taxa
#sig_taxa <- output$res_global  %>%
#  filter(diff_robust_abn) %>%    # use robust results (recommended)
#  left_join(taxonomy, join_by(taxon)) %>%
#  group_by(Genus, taxon, q_val, W) %>%
#  summarise(.groups = "drop") %>%
#  arrange(q_val)

```   
# LFC plot
```{r lfc_plot}
contrast_level <- c("L", "Q", "C", "4", "5")

# log-fold change
lfc_long <- output$res %>%
  dplyr::select(taxon, dplyr::starts_with("lfc_size.mm")) %>%
  pivot_longer(
    cols = -taxon,
    names_to = "contrast",
    values_to = "lfc"
  ) %>%
  mutate(
    contrast = gsub("lfc_size.mm.", "", contrast),
    contrast = factor(contrast, levels = contrast_level)
  )

ggplot(lfc_long, aes(x = contrast, y = lfc, group = taxon, color = taxon)) +
  geom_line(alpha = 0.5) +
  theme_bw() +
  labs(
    x = "Contrast (trend component)",
    y = "Log fold-change",
    title = "Degree and shape of differential abundance across size classes"
  )
```

# Bias corrected abundance
```{r bc}
bc_out <- output$bias_correct_log_table

bc_long <- bc_out %>%
  rownames_to_column("taxon") %>%
  pivot_longer(-taxon, names_to = "sample", values_to = "bc_abund") %>%
  left_join(smd %>% rownames_to_column("sample"), by = "sample")


# can't have boxplot with 3 data points
ggplot(bc_long %>% filter(taxon %in% sig_taxa$taxon),
       aes(x = size.mm, y = bc_abund, color = size.mm)) +
  geom_point() +
  facet_wrap(~ taxon, scales = "free_y") +
  theme_bw() +
  labs(
    x = "Size class",
    y = "Bias-corrected abundance",
    title = "Differential abundance patterns across size classes"
  )

```