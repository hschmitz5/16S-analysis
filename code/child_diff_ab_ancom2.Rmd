---
title: "ANCOM-BC2 Differential Abundance"
output: html_document
date: "2025-10-23"
---
# Generate Diff Abundance Data
```{r diff_ab_ancom2}
fname <- paste0("../results/ancombc2_output.rds")
  
if (file.exists(fname)) {
  print("loading ANCOM2 data")
  output <- readRDS(fname)
} else {
  # filter data that in NOT rarefied 
  # Check that this is consistent with function in 02_filtering.R
  reads <- filter_taxa(ps_filt0, function(x) sum(x > 3) >= (0.2*length(x)), TRUE)
  
  output <- ancombc2(
    data = reads, 
    fix_formula = "size.midpoint",     
    group = "size.midpoint",
    trend = TRUE,  
    p_adj_method = "holm",       
    alpha = 0.05
    #struc_zero = TRUE,           
    #neg_lb = TRUE,              
    #global = FALSE,      # per group estimates (keep size)
  )
  
  saveRDS(output, file = fname)
}
```
# Process Data
```{r ancom2_process}
# renames column
taxonomy <- taxonomy %>%
  rename(taxon = seq,) 

# define significant taxa
#sig_taxa <- output$res_global  %>%
#  filter(diff_robust_abn) %>%    # use robust results (recommended)
#  left_join(taxonomy, join_by(taxon)) %>%
#  group_by(Genus, taxon, q_val, W) %>%
#  summarise(.groups = "drop") %>%
#  arrange(q_val)

```   
# LFC plot
```{r lfc_plot}
contrast_level <- c("L", "Q", "C", "4", "5")

# log-fold change
lfc_long <- output$res %>%
  dplyr::select(taxon, dplyr::starts_with("lfc_size.mm")) %>%
  pivot_longer(
    cols = -taxon,
    names_to = "contrast",
    values_to = "lfc"
  ) %>%
  mutate(
    contrast = gsub("lfc_size.mm.", "", contrast),
    contrast = factor(contrast, levels = contrast_level)
  )

ggplot(lfc_long, aes(x = contrast, y = lfc, group = taxon, color = taxon)) +
  geom_line(alpha = 0.5) +
  theme_bw() +
  labs(
    x = "Contrast (trend component)",
    y = "Log fold-change",
    title = "Degree and shape of differential abundance across size classes"
  )
```

# Bias corrected abundance
```{r bc}
bc_out <- output$bias_correct_log_table

bc_long <- bc_out %>%
  rownames_to_column("taxon") %>%
  pivot_longer(-taxon, names_to = "sample", values_to = "bc_abund") %>%
  left_join(smd %>% rownames_to_column("sample"), by = "sample")


# can't have boxplot with 3 data points
ggplot(bc_long %>% filter(taxon %in% sig_taxa$taxon),
       aes(x = size.mm, y = bc_abund, color = size.mm)) +
  geom_point() +
  facet_wrap(~ taxon, scales = "free_y") +
  theme_bw() +
  labs(
    x = "Size class",
    y = "Bias-corrected abundance",
    title = "Differential abundance patterns across size classes"
  )

```