---
title: "child_diff_abundance"
output: html_document
date: "2025-10-23"
---
# Load ALDEx2 data and define clr
```{r load_data}
effect_threshold <- 1
p_threshold <- 0.05

fname <- "../results/aldex_t.rds"
res0 <- readRDS(fname) %>%
  dplyr::slice(c(4, 7, 9, 10)) # ref: XXL
  # dplyr::slice(c(1, 2, 3, 4)).   # ref: S
  # dplyr::slice(c(1, 5, 8, 10)) # ref: adjacent

# join taxonomy with aldex results
taxonomy <- get_taxonomy(ps_genus)
res <- res0
res$res <- map(res0$res, ~ .x %>%
    rownames_to_column("OTU") %>%
    inner_join(taxonomy, by = join_by("OTU")) %>%
    dplyr::select(OTU, Family, Genus, diff.btw, diff.win, effect, wi.eBH)
  ) 
```
# Define significant taxa

I need to use the same taxa for all
```{r sig}
# add column for number of significant taxa
res <- res %>%
  mutate(
    sig_taxa = map(res, ~ .x %>%
        filter(wi.eBH < p_threshold & abs(effect) > effect_threshold) %>%
        pull(OTU)
    ),
    n_sig = map_dbl(sig_taxa, length)
  )

# names of significant taxa
all_sig_taxa <- unique(unlist(res$sig_taxa))

# Combine into wide format
df_wide <- map2(res$res, res$comparison, ~ .x %>%
      filter(OTU %in% all_sig_taxa) %>%
      mutate(
        effect_update = ifelse(wi.eBH < p_threshold & abs(effect) > effect_threshold, effect, 0)
      ) %>%
      dplyr::select(OTU, Family, Genus, effect_update) %>%
      rename(!! .y := effect_update)
  ) %>%
  reduce(full_join, by = c("OTU", "Family", "Genus")) %>%
  mutate(
    sum_effect = rowSums(across(all_of(res$comparison), abs), na.rm = TRUE),
    mean_effect = rowMeans(across(all_of(res$comparison), abs), na.rm = TRUE)
  ) %>%
  arrange(desc(mean_effect))
```

# Plot top taxa
```{r clr}

# top_taxa <- res0$res[[15]] %>%
#   rownames_to_column("taxon") %>%
#   filter(wi.eBH < 0.05, abs(effect) > effect_threshold) %>%
#   #slice_max(abs(effect), n = 10) %>%
#   pull(taxon)
# 
# clr_long %>%
#   filter(taxon %in% top_taxa) %>%
#   ggplot(aes(x = size.name, y = clr, color = size.name)) +
#   geom_point() +
#   facet_wrap(~ taxon, scales = "free_y") +
#   theme_minimal() +
#   labs(x = "Group", y = "CLR abundance")

```