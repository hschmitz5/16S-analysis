---
title: "child_rank_abundance"
output: html_document
date: "2025-10-23"
---

# Rank Abundance Curve (collapses size)
This shows the genera that have the highest relative abundance, averaged for all samples.
The scatter plot shows the different ASVs that make up each genus.
Most genera are only one ASV, and some are composed of several. 
The bar plot adds up the relative abundance of each ASV.
NA are samples for which the genus was not identified.
This shows a subset of the data -- "n_asv" specifies how many ASVs to include.
```{r rank_abundance_average}

ggplot() +
  # Bars (Sum of ASVs)
  geom_col(
    data = genus_avg,
    aes(x = fct_rev(Genus), y = mean_ab, fill = "Sum of ASVs"),
    width = 0.6,
    show.legend = TRUE
  ) +
  # Error bars
  geom_errorbar(
    data = genus_avg,
    aes(x = fct_rev(Genus), ymin = mean_ab - sd_ab, ymax = mean_ab + sd_ab),
    width = 0.2,
    color = "black"
  ) +
  # Points (Individual ASVs)
  geom_point(
    data = top_asvs,
    aes(x = fct_rev(Genus), y = mean_ab, shape = "Individual ASVs"),
    color = "black",
    size = 2,
    show.legend = TRUE
  ) +
  scale_y_continuous(
    expand = expansion(mult = c(0, 0.1))
  ) +
  labs(
    title = paste("Abundnace > 0.5%"),
    x = "Genus",
    y = "Mean Relative Abundance [%]",
    fill = "",
    shape = ""
  ) +
  scale_fill_manual(
    values = c("Sum of ASVs" = "steelblue"),
    breaks = c("Sum of ASVs")
  ) +
  scale_shape_manual(
    values = c("Individual ASVs" = 16),
    breaks = c("Individual ASVs")
  ) +
  guides(
    shape = guide_legend(order = 1, override.aes = list(fill = NA)),
    fill = guide_legend(order = 2, override.aes = list(shape = NA))
  ) +
  theme_minimal(base_size = 16) +
  theme(
    legend.spacing.y = unit(0.2, "lines"),
    legend.margin = margin(2, 2, 2, 2)
  ) +
  coord_flip()

fname = "../figures/abund_avg.png"
ggsave(fname, width = 8, height = 4, dpi = 300)
```
# Rank Abundance Curve with size
```{r rank_abundance_size}
# Number of genus to display by size
n_display = 3

genus_size2 <- genus_size %>%
  filter(Genus %in% genus_names[1:n_display])   

p <- ggplot(genus_size2, aes(x = Genus, y = mean_ab, fill = as.factor(size.mm))) +
     geom_col(position = position_dodge(width = 0.8), width = 0.7) +
     geom_errorbar(
       aes(ymin = pmax(mean_ab - sd_ab, 0), ymax = mean_ab + sd_ab),
       width = 0.2,
       position = position_dodge(width = 0.8)
     ) +
     scale_fill_manual(
      values = met.brewer("Hiroshige", n_sizes),
      name = "Size [mm]"
     ) +
     scale_y_continuous(
       expand = expansion(mult = c(0, 0.1))  # Add 10% space above
     ) +
     labs(
       title = paste0("Genera = ", n_display),  #paste0: no spaces
       x = "Genus",
       y = "Mean Relative Abundance [%]",
     ) +
     theme_minimal(base_size = 16)   # sets text size

# Save plot
fname <- "../figures/abund_size2.png"
ggsave(fname, plot = p, width = 8, height = 4, dpi = 300)

print(p)
```

# Single scatter plot
This summarizes the relative abundance for one genus at a time.
It shows the variation from the biological replicates.

```{r plot_scatter_single}
#for (i in 1:length(genus_names)) {
i <- 2

gs <- convert_rel(ps_ASV) %>%
  filter(Genus %in% genus_names[i], OTU %in% OTU_names)
  gs %>%
    ggplot(aes(x = size.mm, y = Abundance, fill = OTU)) +
    geom_point(
      shape = 21,
      color = "black",
      size = 3,
      stroke = 1
    ) +
    labs(
       title = genus_names[i],
       x = "Sieve Range [mm]",
       y = "Relative Abundance [%]",
     ) +
    theme_minimal(base_size = 14)   # sets text size
  
  fname = paste0("../figures/genus_",genus_names[i], ".png")
  ggsave(fname, width = 9, height = 4, dpi = 300)
#}
```

# Multiple subplots
This combines multiple genera in subplots
```{r plot_scatter_multiple}

gs.group_plot <- convert_rel(ps_ASV) %>%
  filter(Genus %in% c("Ca_Contendobacter", "Ca_Phosphoribacter"), OTU %in% OTU_names)

### plot
gs.group_plot %>%
  ggplot(aes(x = size.mm, y = Abundance, fill = OTU)) + 
  facet_wrap(~Genus, nrow = 1) +
  geom_point(
    shape = 21,
    color = "black",    # black outline
    size = 3,
    stroke = 1
  ) +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.9, hjust = 1)) +
  xlab("Sieve Range [mm]") +
  ylab("Sum of Relative Abundance [%]")

ggsave("../figures/genus_group.png")
```