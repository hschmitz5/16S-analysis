---
title: "ANCOM-BC2 Differential Abundance"
output: html_document
date: "2025-10-23"
---
# Note: run acombc2 with tax_level = "Genus"

# Load Data and
# Identify globally significant taxa
```{r sig}
library(writexl)
library(ComplexHeatmap)
library(grid)

write2excel <- TRUE

# names of significant taxa
all_sig_taxa <- get_ancom_taxa(ancom_fname, high_ab_genera, write2excel)
high_DA_taxa <- high_ab_genera[high_ab_genera %in% all_sig_taxa]
low_DA_taxa <- all_sig_taxa[!all_sig_taxa %in% high_DA_taxa]
```

# Subset significant taxa and make a matrix for effect
```{r format}
process_lfc <- function(df, taxa) {
  df %>%
    filter(Genus %in% taxa) %>%
    mutate(
      M   = ifelse(diff_size.nameM   & passed_ss_size.nameM,   round(lfc_size.nameM, 2), 0),
      L   = ifelse(diff_size.nameL   & passed_ss_size.nameL,   round(lfc_size.nameL, 2), 0),
      XL  = ifelse(diff_size.nameXL  & passed_ss_size.nameXL,  round(lfc_size.nameXL, 2), 0),
      XXL = ifelse(diff_size.nameXXL & passed_ss_size.nameXXL, round(lfc_size.nameXXL, 2), 0)
    ) %>%
    dplyr::select(Genus, M, L, XL, XXL) %>%
    mutate(
      mean_effect = rowMeans(across(M:XXL, abs), na.rm = TRUE)
    ) %>%
    rename_with(~ paste0(., "-S"), c("M", "L", "XL", "XXL")) %>%
    arrange(desc(mean_effect))
}

output <- readRDS(ancom_fname)
res_prim = output$res %>% rename(Genus = taxon)

# Apply function to high and low abundance taxa
lfc_high <- process_lfc(res_prim, high_DA_taxa)
lfc_low  <- process_lfc(res_prim, low_DA_taxa)

### For plotting
fig_high <- lfc_high %>%
  dplyr::select(-mean_effect) %>%
  tibble::column_to_rownames("Genus") %>%
  as.matrix()

fig_low <- lfc_low %>%
  head(30) %>%
  dplyr::select(-mean_effect) %>%
  tibble::column_to_rownames("Genus") %>%
  as.matrix()
```

# Separate plots
```{r separate_plots}
# Cell height in inches (adjust as needed)
cell_h <- 0.2
cell_w <- 0.6 # same as cell_h

# Font sizes
row_fontsize <- 10
col_fontsize <- 11

# --- High Ab taxa ---
n_cols <- ncol(fig_high)
n_rows <- nrow(fig_high)

ht_high <- Heatmap(
  fig_high,
  name = "log fold\nchange",
  column_title = "High Abundance",
  cluster_columns = FALSE,
  show_row_names = TRUE,
  show_column_names = TRUE,
  column_names_rot = 0,
  column_names_centered = TRUE,
  # size
  width  = unit(n_cols * cell_w, "inches"),
  height = unit(n_rows * cell_h, "inches"),
  row_names_gp = gpar(fontsize = row_fontsize),
  column_names_gp = gpar(fontsize = col_fontsize)
)

# Define rowname width in first plot
ht_grob <- draw(ht_high, show_heatmap_legend = FALSE)
ht1 <- ht_grob@ht_list[[1]]
fig_props <- ht1@layout$layout_size

rowname_width_in <- convertWidth(
  fig_props$row_names_right_width,
  "inches", valueOnly = TRUE
)

common_width <- n_cols * cell_w + rowname_width_in + 2 # in


# --- Low Ab taxa ---
n_rows <- nrow(fig_low)

ht_low <- Heatmap(
  fig_low,
  name = "log fold\nchange",
  column_title = "Low Abundance",
  cluster_columns = FALSE,
  show_row_names = TRUE,
  show_column_names = TRUE,
  column_names_rot = 0,
  column_names_centered = TRUE,
  # size
  width  = unit(n_cols * cell_w, "inches"),
  height = unit(n_rows * cell_h, "inches"),
  row_names_gp = gpar(fontsize = row_fontsize),
  column_names_gp = gpar(fontsize = col_fontsize),
  row_names_max_width = unit(rowname_width_in, "inches")
)

# Save images
png("../figures/ancom_high_ab.png", 
    width = common_width,
    height = n_rows * cell_h + 1,
    units = "in", res = 300)
draw(ht_high)
dev.off()

png("../figures/ancom_low_ab.png", 
    width = common_width,
    height = n_rows * cell_h + 1,
    units = "in", res = 300)
draw(ht_low)
dev.off()
```
# Combined Heatmaps
```{r heatmap}

# High abundance heatmap
ht_high <- Heatmap(
  fig_high,
  name = "High Ab\nlog fold\nchange",
  cluster_columns = FALSE,
  show_row_names = TRUE,
  show_column_names = TRUE,
  column_names_rot = 0,
  column_names_centered = TRUE,
  row_names_gp = gpar(fontsize = row_fontsize),
  column_names_gp = gpar(fontsize = col_fontsize)
)

# Low abundance heatmap
ht_low <- Heatmap(
  fig_low,
  name = "Low Ab\nlog fold\nchange",
  cluster_columns = FALSE,
  show_row_names = TRUE,
  show_column_names = TRUE,
  column_names_rot = 0,
  column_names_centered = TRUE,
  row_names_gp = gpar(fontsize = row_fontsize),
  column_names_gp = gpar(fontsize = col_fontsize)
)

ht_list <- ht_high %v% ht_low

# Draw combined heatmap
png("../figures/ancom_high_low_ab.png",
    width = 6,  # width in inches; can adjust
    height = 8, # height in inches; can adjust
    units = "in", res = 300)
draw(ht_list)
dev.off()

```