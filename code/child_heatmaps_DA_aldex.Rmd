---
title: "child_diff_abundance"
output: html_document
date: "2025-10-23"
---
# Load ALDEx2 data and define clr
```{r load_data}
library(writexl)
library(ComplexHeatmap)
library(grid)

write2excel      <- FALSE
effect_threshold <- 1

all_sig_taxa <- get_aldex_taxa(aldex_fname, p_threshold, effect_threshold, high_ab_genera, write2excel)
high_DA_taxa <- high_ab_genera[high_ab_genera %in% all_sig_taxa]
low_DA_taxa <- all_sig_taxa[!all_sig_taxa %in% high_DA_taxa]
```

# Subset significant taxa and make a matrix for effect
```{r sig}
process_clr <- function(df, taxa, p_threshold, effect_threshold) {
  # Combine into wide format
  map2(df$res, df$comparison, ~ .x %>%
    filter(Genus %in% taxa) %>%
    mutate(
      effect_update = ifelse(wi.eBH < p_threshold & abs(effect) > effect_threshold, effect, 0)
    ) %>%
    dplyr::select(Genus, effect_update) %>%
    rename(!! as.character(.y) := effect_update) 
  ) %>%
  reduce(full_join, by = "Genus") %>%
  mutate(
    mean_effect = rowMeans(across(all_of(df$comparison), abs), na.rm = TRUE)
  ) %>%
  arrange(desc(mean_effect))
}

output <- readRDS(aldex_fname) 
output$res <- map(output$res, ~ .x %>% rownames_to_column("Genus")) 

# Apply function to high and low abundance taxa
effect_high <- process_clr(output, high_DA_taxa, p_threshold, effect_threshold)
effect_low  <- process_clr(output, low_DA_taxa, p_threshold, effect_threshold)

### For plotting
fig_high <- effect_high %>%
  dplyr::select(-mean_effect) %>%
  tibble::column_to_rownames("Genus") %>%
  as.matrix()

fig_low <- effect_low %>%
  head(30) %>%
  dplyr::select(-mean_effect) %>%
  tibble::column_to_rownames("Genus") %>%
  as.matrix()
```

# Separate Heatmaps

```{r low_ab}

# Cell height in inches (adjust as needed)
cell_h <- 0.2
cell_w <- 0.6 # same as cell_h

# Font sizes
row_fontsize <- 10
col_fontsize <- 11

# --- High Ab taxa ---
n_cols <- ncol(fig_high)
n_rows <- nrow(fig_high)

ht_high <- Heatmap(
  fig_high,
  name = "effect",
  column_title = "High Abundance",
  cluster_columns = FALSE,
  show_row_names = TRUE,
  show_column_names = TRUE,
  column_names_rot = 0,
  column_names_centered = TRUE,
  # size
  width  = unit(n_cols * cell_w, "inches"),
  height = unit(n_rows * cell_h, "inches"),
  row_names_gp = gpar(fontsize = row_fontsize),
  column_names_gp = gpar(fontsize = col_fontsize),
)

# Define rowname width in first plot
ht_grob <- draw(ht_high, show_heatmap_legend = FALSE)
ht1 <- ht_grob@ht_list[[1]]
fig_props <- ht1@layout$layout_size

rowname_width_in <- convertWidth(
  fig_props$row_names_right_width,
  "inches", valueOnly = TRUE
)

common_width <- n_cols * cell_w + rowname_width_in + 2 # in


# --- Low Ab taxa ---
n_rows <- nrow(fig_low)

ht_low <- Heatmap(
  fig_low,
  name = "effect",
  column_title = "Low Abundance",
  cluster_columns = FALSE,
  show_row_names = TRUE,
  show_column_names = TRUE,
  column_names_rot = 0,
  column_names_centered = TRUE,
  # size
  width  = unit(n_cols * cell_w, "inches"),
  height = unit(n_rows * cell_h, "inches"),
  row_names_gp = gpar(fontsize = row_fontsize),
  column_names_gp = gpar(fontsize = col_fontsize),
  row_names_max_width = unit(rowname_width_in, "inches")
)

# Save images
png("../figures/aldex_high_ab.png", 
    width = common_width,
    height = n_rows * cell_h + 1,
    units = "in", res = 300)
draw(ht_high)
dev.off()

png("../figures/aldex_low_ab.png", 
    width = common_width,
    height = n_rows * cell_h + 1,
    units = "in", res = 300)
draw(ht_low)
dev.off()


```
# Combined Heatmaps
```{r heatmap}

# High abundance heatmap
ht_high <- Heatmap(
  fig_high,
  name = "High Ab\neffect",
  cluster_columns = FALSE,
  show_row_names = TRUE,
  show_column_names = TRUE,
  column_names_rot = 0,
  column_names_centered = TRUE,
  row_names_gp = gpar(fontsize = row_fontsize),
  column_names_gp = gpar(fontsize = col_fontsize),
)

# Low abundance heatmap
ht_low <- Heatmap(
  fig_low,
  name = "Low Ab\neffect",
  cluster_columns = FALSE,
  show_row_names = TRUE,
  show_column_names = TRUE,
  column_names_rot = 0,
  column_names_centered = TRUE,
  row_names_gp = gpar(fontsize = row_fontsize),
  column_names_gp = gpar(fontsize = col_fontsize),
)

ht_list <- ht_high %v% ht_low

# Draw combined heatmap
png("../figures/aldex_high_low_ab.png",
    width = 6,  # width in inches; can adjust
    height = 8, # height in inches; can adjust
    units = "in", res = 300)
draw(ht_list)
dev.off()

```
